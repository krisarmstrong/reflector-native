# v2.0.0 - Network Extension Framework Requirements

**Target Performance**: 500-800 Mbps (10-16x improvement over v1.8.1)
**Timeline**: 8-13 weeks
**Effort**: High
**Risk**: Medium-High
**Status**: Planning Phase

---

## Executive Summary

v2.0.0 migrates macOS from `/dev/bpf` to Apple's **Network Extension Framework**, achieving 500-800 Mbps throughput through earlier packet interception and modern async APIs. This is a **major architectural change** requiring:

- Apple Developer account with Network Extension entitlements
- System extension development (sandboxed userspace process)
- XPC communication between main app and extension
- Complete code signing and notarization
- User approval workflow for system extension

---

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Architecture Overview](#architecture-overview)
3. [Technical Requirements](#technical-requirements)
4. [Development Environment Setup](#development-environment-setup)
5. [Implementation Phases](#implementation-phases)
6. [Testing Requirements](#testing-requirements)
7. [Deployment Requirements](#deployment-requirements)
8. [Documentation Requirements](#documentation-requirements)
9. [Timeline and Milestones](#timeline-and-milestones)
10. [Risk Assessment](#risk-assessment)

---

## Prerequisites

### 1. Apple Developer Account

**Required**: Apple Developer Program membership
**Cost**: $99/year
**Purpose**: Code signing, entitlements, notarization

**Steps**:
1. Enroll at https://developer.apple.com/programs/
2. Wait for approval (1-2 days)
3. Download signing certificates
4. Configure provisioning profiles

**Documentation**: https://developer.apple.com/support/enrollment/

---

### 2. macOS Version Requirements

**Development Machine**:
- macOS 13 Ventura or later (recommended: macOS 14 Sonoma)
- Xcode 14+ (recommended: Xcode 15+)
- Command Line Tools installed

**Target Deployment**:
- macOS 12 Monterey minimum (NEFilterDataProvider available)
- macOS 13+ recommended (better performance, API improvements)

**Check Compatibility**:
```bash
sw_vers -productVersion  # macOS version
xcodebuild -version      # Xcode version
```

---

### 3. Hardware Requirements

**Development**:
- Mac with Apple Silicon (M1/M2/M3) or Intel
- 16 GB RAM minimum (32 GB recommended)
- SSD with 50 GB free space

**Testing**:
- Multiple Mac models (Intel + Apple Silicon)
- Physical Mac (VMs have limited Network Extension support)
- 1 Gbps network adapter for performance testing

---

### 4. Network Extension Entitlements

**Required Entitlements**:
1. `com.apple.developer.networking.networkextension` - Core framework access
2. `com.apple.security.app-sandbox` - App sandboxing
3. `com.apple.system-extension.install` - System extension installation

**Request Process**:
1. Sign in to Apple Developer portal
2. Create App ID with Network Extension capability
3. Request Network Extension entitlement (may require justification)
4. Create provisioning profile with entitlements

**Approval Time**: 1-7 days (varies)

---

### 5. Knowledge Requirements

**Team Skills Needed**:
- ✅ Objective-C or Swift (for system extension)
- ✅ C programming (existing data plane code)
- ✅ XPC (inter-process communication)
- ✅ macOS system programming
- ✅ Code signing and notarization
- ✅ Async/await patterns (modern Swift)

**Learning Resources**:
- Apple Network Extension Programming Guide
- NEFilterDataProvider documentation
- XPC Services documentation
- System Extensions documentation

---

## Architecture Overview

### Current Architecture (v1.8.1)

```
┌────────────────────────────────────────┐
│  reflector-macos (single process)      │
│  ┌──────────────────────────────────┐  │
│  │  GCD Worker                      │  │
│  │  - open("/dev/bpf0")             │  │
│  │  - read() packets                │  │
│  │  - validate ITO                  │  │
│  │  - reflect in-place              │  │
│  │  - write() packets               │  │
│  └──────────────────────────────────┘  │
└────────────────────────────────────────┘
```

### Target Architecture (v2.0.0)

```
┌─────────────────────────────────────────────────────────────┐
│  reflector-macos (main application)                          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  Control Plane                                       │    │
│  │  - User interface (CLI/TUI)                          │    │
│  │  - Configuration management                          │    │
│  │  - Statistics aggregation                            │    │
│  │  - Extension lifecycle control                       │    │
│  └─────────────────────────────────────────────────────┘    │
│         │                                          ▲          │
│         │ (XPC Connection)                         │          │
│         ▼                                          │          │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  XPC Service                                         │    │
│  │  - Extension communication                           │    │
│  │  - Statistics marshalling                            │    │
│  │  - Configuration updates                             │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
         │                                          ▲
         │ (System XPC)                             │
         ▼                                          │
┌─────────────────────────────────────────────────────────────┐
│  com.reflector.extension (System Extension)                  │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  NEFilterDataProvider                                │    │
│  │  ┌───────────────────────────────────────────────┐  │    │
│  │  │  - handleNewFlow()                            │  │    │
│  │  │    • Identify ITO traffic                     │  │    │
│  │  │    • Create flow metadata                     │  │    │
│  │  │                                               │  │    │
│  │  │  - handleInboundData(flow, data)             │  │    │
│  │  │    • Validate ITO packet                     │  │    │
│  │  │    • Reflect packet (NEON SIMD)              │  │    │
│  │  │    • Return modified data                    │  │    │
│  │  │                                               │  │    │
│  │  │  - handleOutboundData(flow, data)            │  │    │
│  │  │    • Pass through (no reflection needed)     │  │    │
│  │  └───────────────────────────────────────────────┘  │    │
│  │                                                      │    │
│  │  Packet Buffer Pool                                  │    │
│  │  Statistics Accumulator                              │    │
│  │  Flow State Cache                                    │    │
│  └─────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

---

## Technical Requirements

### 1. System Extension Bundle

**Structure**:
```
reflector-macos.app/
├── Contents/
│   ├── MacOS/
│   │   └── reflector-macos              # Main executable
│   ├── Library/
│   │   └── SystemExtensions/
│   │       └── com.reflector.extension.systemextension/
│   │           ├── Contents/
│   │           │   ├── MacOS/
│   │           │   │   └── com.reflector.extension  # Extension binary
│   │           │   └── Info.plist
│   ├── Info.plist
│   └── embedded.provisionprofile
```

**Key Files**:
1. Main app: `reflector-macos` (existing C code + extension manager)
2. System extension: `com.reflector.extension` (NEFilterDataProvider)
3. XPC service: Communication layer

---

### 2. NEFilterDataProvider Implementation

**File**: `src/extension/FilterDataProvider.swift` (NEW)

```swift
import NetworkExtension

class ReflectorFilterDataProvider: NEFilterDataProvider {

    override init() {
        super.init()
        // Initialize packet processor
    }

    // Called when new network flow is detected
    override func handleNewFlow(_ flow: NEFilterFlow) -> NEFilterNewFlowVerdict {
        // Check if this is UDP flow (ITO packets use UDP)
        guard let socketFlow = flow as? NEFilterSocketFlow else {
            return .allow()
        }

        // Filter for UDP only
        if socketFlow.socketProtocol == IPPROTO_UDP {
            // Need data inspection for ITO signature
            return .needRules()
        }

        return .allow()  // Pass through non-UDP traffic
    }

    // Called for inbound data (packets coming in)
    override func handleInboundData(from flow: NEFilterFlow,
                                   readBytesStartOffset offset: Int,
                                   readBytes: Data) -> NEFilterDataVerdict {

        // Validate ITO packet signature
        if isITOPacket(readBytes) {
            // Reflect packet in-place
            let reflected = reflectPacket(readBytes)

            // Statistics
            updateStats(flow: flow, reflected: true)

            // Return modified packet
            return .data(withPassBytes: reflected)
        }

        // Not ITO packet, pass through
        return .allow()
    }

    // Called for outbound data
    override func handleOutboundData(from flow: NEFilterFlow,
                                    readBytesStartOffset offset: Int,
                                    readBytes: Data) -> NEFilterDataVerdict {
        // Pass through outbound (no reflection needed)
        return .allow()
    }

    // ITO packet validation (call into C code)
    private func isITOPacket(_ data: Data) -> Bool {
        return data.withUnsafeBytes { ptr in
            let bytes = ptr.bindMemory(to: UInt8.self).baseAddress!
            return is_ito_packet_wrapper(bytes, UInt32(data.count))
        }
    }

    // Packet reflection (call into C code)
    private func reflectPacket(_ data: Data) -> Data {
        var mutableData = data
        mutableData.withUnsafeMutableBytes { ptr in
            let bytes = ptr.bindMemory(to: UInt8.self).baseAddress!
            reflect_packet_inplace(bytes, UInt32(data.count))
        }
        return mutableData
    }

    private func updateStats(flow: NEFilterFlow, reflected: Bool) {
        // Send stats via XPC to main app
        // Implementation details...
    }
}
```

---

### 3. XPC Communication Layer

**Purpose**: Main app ↔ System extension communication

**File**: `src/xpc/ReflectorXPCProtocol.swift` (NEW)

```swift
import Foundation

@objc protocol ReflectorXPCProtocol {
    // Configuration
    func setConfiguration(_ config: [String: Any], reply: @escaping (Error?) -> Void)
    func getConfiguration(reply: @escaping ([String: Any]?, Error?) -> Void)

    // Statistics
    func getStatistics(reply: @escaping ([String: UInt64]?, Error?) -> Void)
    func resetStatistics(reply: @escaping (Error?) -> Void)

    // Control
    func startReflection(interface: String, reply: @escaping (Error?) -> Void)
    func stopReflection(reply: @escaping (Error?) -> Void)

    // Status
    func getStatus(reply: @escaping (String?, Error?) -> Void)
}
```

**Implementation**: `src/xpc/ReflectorXPCService.swift` (NEW)

```swift
class ReflectorXPCService: NSObject, ReflectorXPCProtocol {

    private let connection: NSXPCConnection

    init(extension: SystemExtension) {
        self.connection = NSXPCConnection(
            machServiceName: "com.reflector.extension"
        )
        self.connection.remoteObjectInterface = NSXPCInterface(
            with: ReflectorXPCProtocol.self
        )
        super.init()
        self.connection.resume()
    }

    func getStatistics(reply: @escaping ([String: UInt64]?, Error?) -> Void) {
        let remote = connection.remoteObjectProxyWithErrorHandler { error in
            reply(nil, error)
        } as! ReflectorXPCProtocol

        remote.getStatistics { stats, error in
            reply(stats, error)
        }
    }

    // Other methods...
}
```

---

### 4. Extension Lifecycle Management

**File**: `src/extension/ExtensionManager.swift` (NEW)

```swift
import SystemExtensions

class ExtensionManager: NSObject {

    func installExtension() {
        let request = OSSystemExtensionRequest.activationRequest(
            forExtensionWithIdentifier: "com.reflector.extension",
            queue: .main
        )
        request.delegate = self
        OSSystemExtensionManager.shared.submitRequest(request)
    }

    func uninstallExtension() {
        let request = OSSystemExtensionRequest.deactivationRequest(
            forExtensionWithIdentifier: "com.reflector.extension",
            queue: .main
        )
        request.delegate = self
        OSSystemExtensionManager.shared.submitRequest(request)
    }
}

extension ExtensionManager: OSSystemExtensionRequestDelegate {

    func request(_ request: OSSystemExtensionRequest,
                 didFinishWithResult result: OSSystemExtensionRequest.Result) {
        print("Extension installed successfully")
        // Start reflection...
    }

    func request(_ request: OSSystemExtensionRequest,
                 didFailWithError error: Error) {
        print("Extension installation failed: \(error)")
    }

    func requestNeedsUserApproval(_ request: OSSystemExtensionRequest) {
        print("Extension requires user approval in System Settings")
    }
}
```

---

### 5. C/Swift Interop Layer

**Purpose**: Reuse existing C validation/reflection code from Swift

**File**: `src/extension/ReflectorBridge.h` (NEW)

```c
#ifndef REFLECTOR_BRIDGE_H
#define REFLECTOR_BRIDGE_H

#include <stdint.h>
#include <stdbool.h>

// Export C functions for Swift
bool is_ito_packet_wrapper(const uint8_t *data, uint32_t len);
void reflect_packet_inplace(uint8_t *data, uint32_t len);
int get_ito_signature_type(const uint8_t *data, uint32_t len);

#endif
```

**File**: `src/extension/ReflectorBridge.c` (NEW)

```c
#include "ReflectorBridge.h"
#include "reflector.h"

// Global MAC address (set during initialization)
static uint8_t g_mac[6] = {0};

void set_interface_mac(const uint8_t mac[6]) {
    memcpy(g_mac, mac, 6);
}

bool is_ito_packet_wrapper(const uint8_t *data, uint32_t len) {
    return is_ito_packet(data, len, g_mac);
}

// Other wrapper functions...
```

---

### 6. Info.plist Configuration

**Main App**: `Info.plist`

```xml
<dict>
    <key>CFBundleIdentifier</key>
    <string>com.reflector.macos</string>

    <key>NSSystemExtensionUsageDescription</key>
    <string>Reflector requires a system extension to perform high-performance packet reflection for network testing.</string>

    <key>SystemExtensions</key>
    <array>
        <string>com.reflector.extension</string>
    </array>
</dict>
```

**System Extension**: `extension/Info.plist`

```xml
<dict>
    <key>CFBundleIdentifier</key>
    <string>com.reflector.extension</string>

    <key>NSExtension</key>
    <dict>
        <key>NSExtensionPointIdentifier</key>
        <string>com.apple.networkextension.filter-data</string>

        <key>NSExtensionPrincipalClass</key>
        <string>$(PRODUCT_MODULE_NAME).ReflectorFilterDataProvider</string>
    </dict>
</dict>
```

---

### 7. Entitlements Files

**Main App**: `reflector-macos.entitlements`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>com.apple.security.app-sandbox</key>
    <true/>

    <key>com.apple.system-extension.install</key>
    <true/>

    <key>com.apple.application-identifier</key>
    <string>$(TeamIdentifierPrefix)com.reflector.macos</string>
</dict>
</plist>
```

**System Extension**: `extension.entitlements`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>com.apple.security.app-sandbox</key>
    <true/>

    <key>com.apple.developer.networking.networkextension</key>
    <array>
        <string>packet-tunnel-provider</string>
        <string>content-filter-provider</string>
    </array>

    <key>com.apple.application-identifier</key>
    <string>$(TeamIdentifierPrefix)com.reflector.extension</string>
</dict>
</plist>
```

---

## Development Environment Setup

### Step 1: Create App ID and Provisioning Profile

```bash
# 1. Sign in to Apple Developer portal
open https://developer.apple.com/account/

# 2. Create App ID
# - Identifier: com.reflector.macos
# - Enable: Network Extensions capability

# 3. Create System Extension App ID
# - Identifier: com.reflector.extension
# - Enable: Network Extensions capability

# 4. Create Provisioning Profiles
# - Development profile for testing
# - Distribution profile for release
```

### Step 2: Download Certificates

```bash
# Download from Xcode
# Xcode > Settings > Accounts > Manage Certificates
# - Apple Development
# - Apple Distribution (for release)

# Or use command line
security find-identity -v -p codesigning
```

### Step 3: Configure Build System

**Option A: Xcode Project** (Recommended)

```bash
# Create Xcode project
mkdir -p reflector-macos.xcodeproj
cd reflector-macos.xcodeproj

# Configure targets:
# 1. Main App (reflector-macos)
# 2. System Extension (com.reflector.extension)
# 3. XPC Service (optional)

# Set code signing:
# - Automatically manage signing: OFF
# - Team: Your team
# - Provisioning Profile: Select downloaded profile
```

**Option B: CMake + codesign** (Advanced)

```cmake
# CMakeLists.txt additions
if(APPLE)
    set(MACOS_BUNDLE_IDENTIFIER "com.reflector.macos")
    set(MACOS_DEVELOPMENT_TEAM "YOUR_TEAM_ID")

    # Main app target
    add_executable(reflector-macos MACOSX_BUNDLE ${SOURCES})

    set_target_properties(reflector-macos PROPERTIES
        MACOSX_BUNDLE_INFO_PLIST "${CMAKE_SOURCE_DIR}/Info.plist"
        XCODE_ATTRIBUTE_CODE_SIGN_ENTITLEMENTS "${CMAKE_SOURCE_DIR}/reflector-macos.entitlements"
        XCODE_ATTRIBUTE_CODE_SIGN_IDENTITY "Apple Development"
        XCODE_ATTRIBUTE_DEVELOPMENT_TEAM "${MACOS_DEVELOPMENT_TEAM}"
    )

    # System extension target
    add_executable(reflector-extension ${EXTENSION_SOURCES})
    # ... similar properties
endif()
```

---

## Implementation Phases

### Phase 1: Proof of Concept (Weeks 1-2)

**Goal**: Validate Network Extension can intercept and modify packets

**Tasks**:
- [ ] Set up Apple Developer account
- [ ] Create minimal NEFilterDataProvider
- [ ] Implement basic packet interception (log only, no reflection)
- [ ] Test extension installation and approval workflow
- [ ] Measure baseline overhead (latency, throughput)

**Deliverables**:
- Working system extension that logs UDP packets
- Performance baseline measurements
- Go/no-go decision on performance viability

---

### Phase 2: Core Packet Processing (Weeks 3-5)

**Goal**: Implement ITO packet validation and reflection

**Tasks**:
- [ ] Create C/Swift bridge for existing packet code
- [ ] Implement ITO packet detection in extension
- [ ] Port reflection logic (reuse NEON SIMD code)
- [ ] Add basic statistics collection
- [ ] Implement XPC communication for stats

**Deliverables**:
- Extension can detect and reflect ITO packets
- Statistics available via XPC to main app
- Initial performance measurements

---

### Phase 3: XPC Communication & Control (Weeks 6-7)

**Goal**: Full bidirectional communication between app and extension

**Tasks**:
- [ ] Implement XPC protocol (configuration, stats, control)
- [ ] Add extension lifecycle management
- [ ] Implement configuration updates at runtime
- [ ] Add error handling and recovery
- [ ] Implement graceful shutdown

**Deliverables**:
- Main app can control extension via XPC
- Real-time statistics display
- Configuration management working

---

### Phase 4: Optimization & Testing (Weeks 8-10)

**Goal**: Achieve 500-800 Mbps target performance

**Tasks**:
- [ ] Profile hot paths with Instruments
- [ ] Optimize XPC communication (reduce overhead)
- [ ] Implement flow state caching
- [ ] Add packet buffer pooling
- [ ] Tune batch sizes and buffers
- [ ] Performance testing on multiple Mac models

**Deliverables**:
- 500+ Mbps sustained throughput
- Performance benchmarks documented
- Optimization guide

---

### Phase 5: Code Signing & Distribution (Weeks 11-12)

**Goal**: Prepare for distribution

**Tasks**:
- [ ] Set up distribution signing
- [ ] Implement notarization workflow
- [ ] Create installer package
- [ ] Add update mechanism
- [ ] Document installation process
- [ ] Test on clean macOS installs

**Deliverables**:
- Signed and notarized app bundle
- Installation documentation
- Distribution-ready build

---

### Phase 6: Documentation & Release (Week 13)

**Goal**: Release v2.0.0

**Tasks**:
- [ ] Write comprehensive documentation
- [ ] Create migration guide from v1.x
- [ ] Update ROADMAP and CHANGELOG
- [ ] Create release notes
- [ ] Tag v2.0.0 release
- [ ] Announce release

**Deliverables**:
- Complete v2.0.0 documentation
- Tagged release
- Migration guide

---

## Testing Requirements

### Unit Tests

- [ ] ITO packet detection (Swift + C)
- [ ] Packet reflection (existing C tests still valid)
- [ ] XPC communication
- [ ] Statistics accumulation
- [ ] Configuration management

### Integration Tests

- [ ] Extension installation/uninstallation
- [ ] Packet flow through extension
- [ ] Statistics accuracy
- [ ] Configuration updates
- [ ] Error handling

### Performance Tests

**Target Metrics**:
- Throughput: 500-800 Mbps sustained
- Latency: <2000ns per packet
- CPU usage: <60% of single core
- Memory: <200 MB total (app + extension)

**Test Scenarios**:
1. Minimal frames (64 bytes)
2. Standard frames (1500 bytes)
3. Jumbo frames (9000 bytes)
4. Mixed sizes
5. Sustained load (1+ hour)
6. Burst traffic
7. Multiple interfaces

### Hardware Coverage

- [ ] Apple Silicon (M1/M2/M3)
- [ ] Intel Mac
- [ ] macOS 12 Monterey
- [ ] macOS 13 Ventura
- [ ] macOS 14 Sonoma

---

## Deployment Requirements

### Code Signing

**Certificates Needed**:
- Apple Development (for testing)
- Apple Distribution (for release)
- Developer ID Application (for outside App Store)

**Signing Process**:
```bash
# Sign extension
codesign --deep --force --verify --verbose \
    --sign "Apple Development: Your Name (TEAMID)" \
    --entitlements extension.entitlements \
    reflector-macos.app/Contents/Library/SystemExtensions/com.reflector.extension.systemextension

# Sign main app
codesign --deep --force --verify --verbose \
    --sign "Apple Development: Your Name (TEAMID)" \
    --entitlements reflector-macos.entitlements \
    reflector-macos.app

# Verify
codesign --verify --deep --verbose=2 reflector-macos.app
```

### Notarization

**Required for distribution outside Mac App Store**:

```bash
# Create archive
ditto -c -k --keepParent reflector-macos.app reflector-macos.zip

# Submit for notarization
xcrun notarytool submit reflector-macos.zip \
    --apple-id "your-apple-id@email.com" \
    --team-id "TEAMID" \
    --password "app-specific-password" \
    --wait

# Staple notarization ticket
xcrun stapler staple reflector-macos.app
```

### Installation Package

**Create DMG**:
```bash
create-dmg \
    --volname "Reflector v2.0.0" \
    --window-pos 200 120 \
    --window-size 800 400 \
    --icon-size 100 \
    --icon "reflector-macos.app" 200 190 \
    --app-drop-link 600 185 \
    "Reflector-2.0.0.dmg" \
    "reflector-macos.app"
```

---

## Documentation Requirements

### User Documentation

- [ ] Installation guide (with system extension approval)
- [ ] Getting started tutorial
- [ ] Configuration reference
- [ ] Troubleshooting common issues
- [ ] Performance tuning guide
- [ ] Migration guide from v1.x

### Developer Documentation

- [ ] Architecture overview
- [ ] Building from source
- [ ] Code signing setup
- [ ] XPC protocol specification
- [ ] Extension development guide
- [ ] Performance profiling guide

### API Documentation

- [ ] Swift API documentation (inline)
- [ ] XPC protocol documentation
- [ ] Configuration options
- [ ] Statistics format

---

## Timeline and Milestones

### Week 1-2: Setup & PoC
- [ ] Apple Developer account setup
- [ ] Development environment configured
- [ ] Minimal extension working
- **Milestone**: Extension intercepts packets

### Week 3-5: Core Implementation
- [ ] ITO packet detection
- [ ] Packet reflection working
- [ ] Basic XPC communication
- **Milestone**: End-to-end packet reflection

### Week 6-7: Control & Management
- [ ] Full XPC protocol
- [ ] Extension lifecycle management
- [ ] Configuration updates
- **Milestone**: Feature-complete alpha

### Week 8-10: Optimization
- [ ] Performance profiling
- [ ] Hot path optimizations
- [ ] Target 500+ Mbps achieved
- **Milestone**: Performance targets met

### Week 11-12: Release Preparation
- [ ] Code signing & notarization
- [ ] Distribution package
- [ ] Testing on clean installs
- **Milestone**: Release candidate

### Week 13: Release
- [ ] Final documentation
- [ ] Release notes
- [ ] Tag v2.0.0
- **Milestone**: v2.0.0 released

---

## Risk Assessment

### High Risk

**Risk**: Apple rejects Network Extension entitlement
**Mitigation**: Provide detailed justification, show existing BPF implementation
**Probability**: Low (legitimate use case)
**Impact**: Critical (blocks entire v2.0.0)

**Risk**: Performance worse than expected (<500 Mbps)
**Mitigation**: Early PoC to validate, fallback to v1.9.0 if needed
**Probability**: Medium
**Impact**: High (defeats purpose)

### Medium Risk

**Risk**: System extension debugging is difficult
**Mitigation**: Extensive logging, use Console.app, fallback debug build
**Probability**: High
**Impact**: Medium (slower development)

**Risk**: XPC overhead reduces performance
**Mitigation**: Minimize XPC calls, batch statistics, profile early
**Probability**: Medium
**Impact**: Medium (10-20% performance loss)

### Low Risk

**Risk**: Code signing issues
**Mitigation**: Good documentation, early testing
**Probability**: Medium
**Impact**: Low (can be resolved)

**Risk**: User resistance to system extension approval
**Mitigation**: Clear documentation, explain benefits
**Probability**: Low
**Impact**: Low (UX issue, not technical)

---

## Success Criteria

### Must Have
- ✅ 500+ Mbps sustained throughput
- ✅ Zero data loss (all ITO packets reflected)
- ✅ Signed and notarized
- ✅ Works on macOS 12+
- ✅ Comprehensive documentation

### Should Have
- ✅ 700+ Mbps sustained throughput
- ✅ <60% CPU usage
- ✅ Easy installation experience
- ✅ Graceful degradation on errors
- ✅ Migration path from v1.x

### Nice to Have
- ✅ 800+ Mbps sustained throughput
- ✅ <1500ns per-packet latency
- ✅ Automatic updates
- ✅ Performance profiling tools
- ✅ Web-based configuration UI

---

## Cost Summary

| Item | Cost | Frequency |
|------|------|-----------|
| Apple Developer Account | $99 | Annual |
| Code Signing Certificate | Included | - |
| Development Mac | $0 | One-time (assumed owned) |
| Testing Hardware | $0 | One-time (assumed owned) |
| **Total** | **$99/year** | - |

---

## Next Steps

1. **Immediate**: Get Apple Developer account ($99)
2. **Week 1**: Set up development environment
3. **Week 1-2**: Build proof of concept
4. **Week 2**: Go/no-go decision based on PoC performance
5. **Week 3+**: Full implementation if approved

---

## Approval Required

- [ ] Budget approval ($99/year Apple Developer account)
- [ ] Timeline approval (8-13 weeks)
- [ ] Resource allocation (1 developer full-time)
- [ ] Go/no-go after PoC (Week 2)

---

**Document Status**: Ready for review
**Next Action**: Obtain approvals and begin Phase 1
**Owner**: TBD
**Target Start Date**: TBD
