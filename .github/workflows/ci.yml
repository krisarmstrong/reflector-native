name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang clang-format clang-tidy \
                                cppcheck valgrind libelf-dev zlib1g-dev gcovr

    - name: Build
      run: make clean && make

    - name: Run all tests
      run: make test-all

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: linux-test-results
        path: tests/test_*

  build-linux-xdp:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Install AF_XDP dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang libelf-dev zlib1g-dev \
                                libxdp-dev libbpf-dev linux-headers-generic

    - name: Build with AF_XDP
      run: |
        make clean
        make
        echo "Verifying AF_XDP support was enabled..."
        if [ ! -f "src/xdp/filter.bpf.o" ]; then
          echo "⚠️ Warning: eBPF filter not compiled"
        fi

    - name: Run tests
      run: make test-all

  build-macos:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v3

    - name: Build
      run: make clean && make

    - name: Run all tests
      run: make test-all

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: macos-test-results
        path: tests/test_*

  code-quality:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-format clang-tidy cppcheck

    - name: Check code formatting
      run: make format-check

    - name: Run cppcheck
      run: make cppcheck

    - name: Upload cppcheck report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: cppcheck-report
        path: cppcheck-report.txt

  memory-safety:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang valgrind

    - name: Run Address Sanitizer tests
      run: make test-asan

    - name: Run UB Sanitizer tests
      run: make test-ubsan

    - name: Run valgrind tests
      run: |
        make clean && make
        make test-valgrind

  coverage:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential gcc gcov gcovr lcov

    - name: Generate coverage
      run: make coverage

    - name: Generate coverage report
      run: |
        if command -v lcov >/dev/null 2>&1; then
          lcov --capture --directory . --output-file coverage.info || true
          lcov --remove coverage.info '/usr/*' --output-file coverage.info || true
          lcov --list coverage.info || true
          echo "Coverage data collected"
        fi

    - name: Upload coverage artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: |
          *.gcov
          coverage.info

  benchmark:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential

    - name: Build
      run: make clean && make

    - name: Run benchmarks
      run: make test-benchmark

    - name: Upload benchmark results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: tests/test_benchmark
