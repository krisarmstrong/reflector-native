#!/bin/bash
# Pre-commit hook: security checks and tests before allowing commit

set -e

echo "Running pre-commit checks..."

ERRORS=0

# Security check: detect secrets
echo "üîí Checking for secrets..."
if git diff --cached --name-only | xargs grep -nHE "(password|secret|api[_-]?key|token|private[_-]?key|credential)['\"]?\s*[:=]" 2>/dev/null; then
    echo "‚ùå Potential secret detected! Review the above lines."
    echo "   If this is a false positive, add 'nosec' comment on that line"
    ERRORS=$((ERRORS + 1))
fi

# Security check: large files
echo "üì¶ Checking for large files..."
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        SIZE=$(wc -c < "$file")
        if [ $SIZE -gt 1048576 ]; then  # 1MB
            echo "‚ùå Large file detected: $file ($(($SIZE / 1024))KB)"
            echo "   Consider using Git LFS or excluding from repository"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

# Security check: direct commits to main
BRANCH=$(git symbolic-ref --short HEAD)
if [ "$BRANCH" = "main" ]; then
    echo "‚ö†Ô∏è  Warning: Direct commit to main branch"
    echo "   Consider using feature branches and pull requests"
fi

# Code quality: trailing whitespace
echo "üßπ Checking for trailing whitespace..."
if git diff --cached --check 2>&1 | grep -q "trailing whitespace"; then
    echo "‚ùå Trailing whitespace detected"
    echo "   Run: git diff --cached --check"
    ERRORS=$((ERRORS + 1))
fi

# Code formatting: clang-format
if command -v clang-format >/dev/null 2>&1; then
    echo "üé® Checking code formatting..."
    UNFORMATTED_FILES=""
    for file in $(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|h)$'); do
        if [ -f "$file" ]; then
            # Check if file would be modified by clang-format
            if ! clang-format --dry-run --Werror "$file" >/dev/null 2>&1; then
                UNFORMATTED_FILES="$UNFORMATTED_FILES\n  $file"
            fi
        fi
    done

    if [ -n "$UNFORMATTED_FILES" ]; then
        echo "‚ùå Code formatting issues detected in:$UNFORMATTED_FILES"
        echo "   Run: clang-format -i <file> to fix formatting"
        echo "   Or run: find src include -name '*.[ch]' -exec clang-format -i {} +"
        ERRORS=$((ERRORS + 1))
    fi
else
    echo "‚ö†Ô∏è  clang-format not found, skipping format check"
    echo "   Install with: brew install clang-format (macOS) or apt install clang-format (Linux)"
fi

# Check if we have uncommitted changes to source files
if git diff --cached --name-only | grep -qE '\.(c|h)$'; then
    echo "üß™ Source files modified - running tests..."

    # Build and test
    make clean > /dev/null 2>&1
    make > /dev/null 2>&1

    if ! make test; then
        echo "‚ùå Tests failed! Commit aborted."
        echo "Fix the tests or use 'git commit --no-verify' to skip (not recommended)"
        ERRORS=$((ERRORS + 1))
    else
        echo "‚úÖ All tests passed!"
    fi
fi

if [ $ERRORS -gt 0 ]; then
    echo ""
    echo "‚ùå Pre-commit checks failed with $ERRORS error(s)"
    echo "Fix the issues or use 'git commit --no-verify' to skip (not recommended)"
    exit 1
fi

echo "‚úÖ All pre-commit checks passed"
exit 0
